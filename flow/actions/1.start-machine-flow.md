# Start Machine Flow Documentation

## Introduction

This document describes the flow for starting machines through the user interface. When a user selects and starts machines on the UI, the backend sends start machine actions to the appropriate controllers, which then acknowledge the action with success or error status.

**Flow Overview:**
1. User chooses and starts machines on the UI
2. Backend sends `start_machine` action to the controller
3. Controller receives action and sends acknowledgment back to the backend (success or error)

## MQTT Topics

### Action Topic
Backend sends start machine actions to:
```
/stores/<store_id>/controllers/<controller_id>/actions
```

Where:
- `<store_id>` is the UUID of the store
- `<controller_id>` is the UUID of the controller managing the machines

### Acknowledgment Topic
Controllers send acknowledgments to:
```
/stores/<store_id>/controllers/<controller_id>/ack
```

Where:
- `<store_id>` is the UUID of the store
- `<controller_id>` is the UUID of the controller

## Schema

### Start Machine Action Message
```json
{
  "version": "string",
  "event_type": "string",
  "timestamp": "string",
  "correlation_id": "string",
  "controller_id": "string",
  "store_id": "string",
  "payload": "object"
}
```

### Acknowledgment Message
```json
{
  "version": "string",
  "event_type": "string",
  "timestamp": "string",
  "correlation_id": "string",
  "controller_id": "string",
  "store_id": "string",
  "payload": "object"
}
```

## Field Descriptions

### Action Message Fields

#### `event_type`
- **Type:** `string`
- **Format:** Enum value
- **Purpose:** Identifies the type of machine and action
- **Values:** 
  - `"start_washer"` - Action to start a washer machine
  - `"start_dryer"` - Action to start a dryer machine
- **Required:** Yes

#### `payload`
- **Type:** `object`
- **Format:** JSON object
- **Purpose:** Contains relay control configuration
- **Required:** Yes
- **Structure:**
  ```json
  {
    "machine_type": "washer | dryer",
    "relay_id": "number",
    "pulse_duration": "number",
    "value": "number"
  }
  ```
- **Fields:**
  - `machine_type`: Type of machine being controlled (`"washer"` or `"dryer"`)
  - `relay_id`: ID of the relay controlling the machine
  - `pulse_duration`: Duration in milliseconds for the pulse
  - `value`: Value to send to the relay

### Acknowledgment Message Fields

#### `event_type`
- **Type:** `string`
- **Format:** Enum value
- **Purpose:** Identifies the type of acknowledgment
- **Values:** 
  - `"start_washer_ack"` - Acknowledgment for start washer action
  - `"start_dryer_ack"` - Acknowledgment for start dryer action
- **Required:** Yes

#### `payload`
- **Type:** `object`
- **Format:** JSON object
- **Purpose:** Contains acknowledgment status and details
- **Required:** Yes
- **Structure:**
  ```json
  {
    "status": "success | error",
    "machine_type": "washer | dryer",
    "relay_id": "number",
    "message": "string"
  }
  ```
- **Fields:**
  - `status`: Either `"success"` or `"error"` indicating the result
  - `machine_type`: Type of machine that was controlled (`"washer"` or `"dryer"`)
  - `relay_id`: ID of the relay that was controlled
  - `message`: Additional details about the result (error message or confirmation)

## Flow Steps

### Step 1: User Starts Machine
User selects and starts a machine through the UI interface.

### Step 2: Backend Sends Start Machine Action
Backend publishes start machine action to the controller:

**Start Washer Action Message:**
```json
{
  "version": "1.0.0",
  "event_type": "start_washer",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "machine_type": "washer",
    "relay_id": 2,
    "pulse_duration": 1000,
    "value": 1
  }
}
```

### Step 3: Controller Processes Action
Controller receives the action and:
- Validates the relay_id
- Executes the relay control action
- Determines success or error status

### Step 4: Controller Sends Acknowledgment
Controller sends acknowledgment back to the backend:

**Success Acknowledgment:**
```json
{
  "version": "1.0.0",
  "event_type": "start_washer_ack",
  "timestamp": "2024-01-15T15:30:26+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "status": "success",
    "machine_type": "washer",
    "relay_id": 2,
    "message": "Washer started successfully"
  }
}
```

**Error Acknowledgment:**
```json
{
  "version": "1.0.0",
  "event_type": "start_washer_ack",
  "timestamp": "2024-01-15T15:30:26+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "status": "error",
    "machine_type": "washer",
    "relay_id": 2,
    "message": "Relay not responding"
  }
}
```

## Error Handling

### Common Error Scenarios
- **Invalid relay_id**: Relay not found or not configured
- **Relay failure**: Hardware relay not responding
- **Communication timeout**: Controller doesn't respond within expected time
- **Invalid parameters**: Invalid pulse_duration or value

### Retry Logic
- Backend may retry failed actions after a timeout period
- Controllers should handle duplicate actions gracefully
- UI should show appropriate error messages to users

## Security Considerations

- Controllers should validate that actions are for their assigned store
- Messages should be validated against the schema
- Consider implementing message authentication for production use
- Rate limiting should be applied to prevent abuse
