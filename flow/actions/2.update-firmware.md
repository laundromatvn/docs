# Introduction

# Flow

## When user trigger to update firmware
### Step 1: Backend sends UPDATE_FIRMWARE

Topic: `/stores/<store_id>/controllers/<controller_id>/actions`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "update_firmware",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
    "firmware_version": "1.0.1",
    "file_url": "https://example.com/firmware-1-0-1.bin",
    "file_size": 779,
    "checksum": "8a3be389a446bba670da3a33e5506d2e",
  }
}
```

### Step 2: Controller ack UPDATE_FIRMWARE_ACK

Topic: `/stores/<store_id>/controllers/<controller_id>/ack`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "update_firmware_ack",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
  }
}
```

### Step 3: Compare current controller version and version server sent
### If different controller start update

## When update completed
### Step 1: Controller perform soft reset 
### Step 2: Get firmware version from handshake with server and compare to current version

## When update success - Firmware version from handshake with server different to current version
### Step 1: Controller send UPDATE_FIRMWARE_COMPLETED

Topic: `/stores/<store_id>/controllers/<controller_id>/actions`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "update_firmware_completed",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
  }
}
```
### Step 2: Backend update new version of controller firmware

## When update failed - Firmware version from handshake with server same with current version 
### Step 1: Controller send UPDATE_FIRMWARE_FAILED

Topic: `/stores/<store_id>/controllers/<controller_id>/actions`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "update_firmware_failed",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
    "errors": [
        "error message 1",
        "error message 2",
        ...
    ]
  }
}
```

## When user cancel update firmware
### Step 1: Backend sends CANCEL_UPDATE_FIRMWARE

Topic: `/stores/<store_id>/controllers/<controller_id>/actions`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "cancel_update_firmware",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
  }
}
```

### Step 2: Controller ack CANCEL_UPDATE_FIRMWARE_ACK

Topic: `/stores/<store_id>/controllers/<controller_id>/ack`

Schema:
```
{
  "version": "1.0.0",
  "event_type": "cancel_update_firmware_ack",
  "timestamp": "2024-01-15T15:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440003",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "deployment_id": "7f56308b-3e98-4faf-8a61-ead5d139a5b1",
  }
}
```