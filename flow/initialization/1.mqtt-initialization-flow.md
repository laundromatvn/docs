# MQTT Initialization Flow Documentation

## Introduction

This document describes the MQTT initialization flow that handles controller startup and store assignment. The flow determines whether a controller is ready for operation or needs to wait for store assignment.

**Flow Logic:**
1. Controller sends initialization request with its identifier
2. Backend checks if the controller has an assigned store
3. **If no assigned store:** Backend responds with `status = PENDING_ASSIGNMENT` - controller enters waiting state
4. **If has assigned store:** Backend responds with `store_id` and `status = ASSIGNED` - controller receives configuration and begins operation
5. **After assignment:** Controller listens to actions on topic `/stores/<store-id>/controllers/<controller-id>/actions`

## MQTT Topics

### Initialization Topic
All initialization messages are published to the topic:
```
/initialization
```

### Actions Topic
After successful assignment, controllers listen for actions on:
```
/stores/<store-id>/controllers/<controller-id>/actions
```

Where:
- `<store-id>` is the UUID of the assigned store
- `<controller-id>` is the UUID of the controller

## Schema

The initialization messages follow a unified JSON schema structure:

```json
{
  "version": "string",
  "event_type": "string", 
  "timestamp": "string",
  "correlation_id": "string",
  "controller_id": "string",
  "store_id": "string | null",
  "payload": "object | null"
}
```

## Field Descriptions

### `event_type`
- **Type:** `string`
- **Format:** Enum value
- **Purpose:** Identifies the type of initialization event
- **Values:** 
  - `"controller_init_request"` - Controller requesting configuration
  - `"controller_init_response"` - Backend responding with configuration
- **Required:** Yes

### `store_id`
- **Type:** `string | null`
- **Format:** UUID v4 or null
- **Purpose:** Identifier of the store the controller is assigned to
- **Example:** `"6ba7b811-9dad-11d1-80b4-00c04fd430c8"` or `null`
- **Required:** Yes
- **Note:** May be null if controller is not yet assigned to a store

### `payload`
- **Type:** `object | null`
- **Format:** JSON object or null
- **Purpose:** Contains status and configuration data for the controller
- **Required:** Yes
- **Scenarios:**
  
  **For controllers without store assignment:**
  ```json
  {
    "status": "PENDING_ASSIGNMENT"
  }
  ```
  
  **For assigned controllers:**
  ```json
  {
    "status": "assigned",
    "pulse_duration": 5000
  }
  ```
- **Fields:**
  - `status`: Either `"PENDING_ASSIGNMENT"` or `"ASSIGNED"` based on controller's store assignment state
  - `pulse_duration`: Configuration value in milliseconds (only present when `status = "ASSIGNED"`)

## Examples

### Example 1: New Controller (No Store Assigned)

**Request Message:**
```json
{
  "version": "1.0.0",
  "event_type": "controller_init_request",
  "timestamp": "2024-01-15T14:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": null,
  "payload": null
}
```

**Response Message:**
```json
{
  "version": "1.0.0",
  "event_type": "controller_init_response",
  "timestamp": "2024-01-15T14:30:26+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": null,
  "payload": {
    "status": "PENDING_ASSIGNMENT"
  }
}
```

**Note:** Controllers with no store assignment receive `status = PENDING_ASSIGNMENT` and enter the waiting for store assigned flow.

### Example 2: Existing Controller with Store Assignment

**Request Message:**
```json
{
  "version": "1.0.0",
  "event_type": "controller_init_request",
  "timestamp": "2024-01-15T14:30:25+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440001",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": null
}
```

**Response Message:**
```json
{
  "version": "1.0.0",
  "event_type": "controller_init_response",
  "timestamp": "2024-01-15T14:30:26+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440001",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "status": "ASSIGNED",
    "pulse_duration": 5000
  }
}
```
