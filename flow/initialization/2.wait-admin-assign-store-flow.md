# Wait Admin Assign Store Flow Documentation

## Introduction

This document describes the flow that occurs after a controller receives a `PENDING_ASSIGNMENT` status during initialization. The controller enters a waiting state where it listens for store assignment from an administrator, then transitions to active operation once assigned.

**Flow Overview:**
1. Controller receives `PENDING_ASSIGNMENT` status from initialization flow
2. Controller listens on a dedicated topic for store assignment
3. Administrator clicks "Check" button to verify the controller
4. Backend sends verification action to controller, triggering relay LED
5. Admin confirms the LED activation at the physical store location
6. Admin clicks "Assign" to assign the controller to a store
7. Backend sends store assignment to the controller
8. Controller updates its status to `ASSIGNED` and begins normal operation
9. Controller starts receiving configuration from the backend

## MQTT Topics

### Controller Listening Topic
Controllers listen for store assignment on:
```
/controller/<controller_id>/wait_admin_assign_store
```

Where `<controller_id>` is the UUID of the specific controller.

### Backend Publishing Topic
Backend publishes store assignments to the same topic:
```
/controller/<controller_id>/wait_admin_assign_store
```

## Schema

The store assignment messages follow this JSON schema:

```json
{
  "version": "string",
  "event_type": "string",
  "timestamp": "string",
  "correlation_id": "string",
  "controller_id": "string",
  "store_id": "string",
  "payload": "object"
}
```

## Field Descriptions

### `event_type`
- **Type:** `string`
- **Format:** Enum value
- **Purpose:** Identifies the type of store assignment event
- **Values:** 
  - `"store_assignment"` - Backend assigning a store to the controller
- **Required:** Yes

### `store_id`
- **Type:** `string`
- **Format:** UUID v4
- **Purpose:** Identifier of the store being assigned to the controller
- **Example:** `"6ba7b811-9dad-11d1-80b4-00c04fd430c8"`
- **Required:** Yes

### `payload`
- **Type:** `object`
- **Format:** JSON object
- **Purpose:** Contains assignment confirmation and initial configuration data
- **Required:** Yes
- **Structure:**
  ```json
  {
    "status": "ASSIGNED",
    "pulse_duration": 5000
  }
  ```
- **Fields:**
  - `status`: Always `"ASSIGNED"` to indicate successful store assignment
  - `pulse_duration`: Initial configuration value in milliseconds for the controller's pulse timing

## Flow Steps

### Step 1: Controller Receives PENDING_ASSIGNMENT
After initialization, controller receives:
```json
{
  "version": "1.0.0",
  "event_type": "controller_init_response",
  "timestamp": "2024-01-15T14:30:26+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": null,
  "payload": {
    "status": "PENDING_ASSIGNMENT"
  }
}
```

### Step 2: Controller Starts Listening
Controller subscribes to topics:
```
/controller/6ba7b810-9dad-11d1-80b4-00c04fd430c8/wait_admin_assign_store
```

### Step 3: Admin Verification Process
Administrator clicks "Check" button in the admin interface to verify the controller.

### Step 4: Backend Sends Verification Action
Backend sends verification action to trigger relay LED:

**Verification Action Message:**
```json
{
  "version": "1.0.0",
  "event_type": "controller_verification",
  "timestamp": "2024-01-15T14:32:15+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440001",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": null,
  "payload": {
    "relay_id": 1,
    "pulse_duration": 50,
    "value": 10
  }
}
```

### Step 5: Controller Activates LED
Controller receives the action and activates the LED on the specified relay for verification.

### Step 6: Admin Confirms LED Activation
Admin observes the LED activation at the physical store location and confirms the controller is working correctly.

### Step 7: Admin Assignment Process
Administrator clicks "Assign" button to assign the controller to the store.

### Step 8: Backend Sends Store Assignment
Backend publishes to the controller's topic:

**Store Assignment Message:**
```json
{
  "version": "1.0.0",
  "event_type": "store_assignment",
  "timestamp": "2024-01-15T14:35:10+07:00",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440002",
  "controller_id": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
  "store_id": "6ba7b811-9dad-11d1-80b4-00c04fd430c8",
  "payload": {
    "status": "ASSIGNED",
    "pulse_duration": 5000
  }
}
```

### Step 9: Controller Updates Status
Controller receives the assignment message and:
- Updates its internal status to `ASSIGNED`
- Stores the assigned `store_id`
- Applies the received configuration (e.g., `pulse_duration`)

### Step 10: Controller Begins Normal Operation
Controller:
- Unsubscribes from the wait and verification topics
- Begins normal operation with the assigned store
- Starts receiving regular configuration updates from the backend

## State Transitions

```
PENDING_ASSIGNMENT → [Admin Check] → [LED Verification] → [Admin Assign] → ASSIGNED → [Normal Operation]
```

## Error Handling

### Timeout Scenarios
- If no assignment is received within a reasonable time, the controller may:
  - Re-request initialization
  - Enter a retry loop
  - Alert the system of the pending state

### Invalid Assignments
- Controllers should validate received store assignments
- Invalid or malformed messages should be ignored
- Controllers should continue listening for valid assignments

## Security Considerations

- Controllers should only accept assignments for their own `controller_id`
- Messages should be validated against the schema
- Consider implementing message authentication for production use
